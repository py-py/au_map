var data = [{
    "id": 327,
    "coordinates": {
      "id": 840,
      "x1": 10,
      "y1": 10,
      "x2": 100,
      "y2": 10
    },
    "has_coordinates": true,
    "is_updated": false,
    "name": "Main-М'ясо"
  },
  {
    "id": 328,
    "coordinates": {
      "id": 841,
      "x1": 20,
      "y1": 20,
      "x2": 120,
      "y2": 120
    },
    "has_coordinates": true,
    "is_updated": false,
    "name": "Main-Копченості"
  },
  {
    "id": 329,
    "coordinates": {
      "id": 842,
      "x1": 30,
      "y1": 40,
      "x2": 100,
      "y2": 100
    },
    "has_coordinates": true,
    "is_updated": false,
    "name": "Main-Хліб"
  },
  {
    "id": 330,
    "coordinates": {
      "id": 843,
      "x1": 40,
      "y1": 40,
      "x2": 100,
      "y2": 100
    },
    "has_coordinates": true,
    "is_updated": false,
    "name": "Main-Пекарня"
  },
  {
    "id": 331,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Ковбаса та сир"
  },
  {
    "id": 332,
    "coordinates": {
      "id": 845,
      "x1": 150,
      "y1": 250,
      "x2": 150,
      "y2": 250
    },
    "has_coordinates": true,
    "is_updated": false,
    "name": "Main-Молочні продукти, яйця"
  },
  {
    "id": 333,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Заморожені продукти"
  },
  {
    "id": 334,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Риба"
  },
  {
    "id": 335,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Овочі, фрукти"
  },
  {
    "id": 336,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Товари на вагу"
  },
  {
    "id": 337,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Кафе"
  },
  {
    "id": 338,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Кулінарія"
  },
  {
    "id": 339,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Бакалія"
  },
  {
    "id": 340,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Алкогольні напої"
  },
  {
    "id": 341,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Тютюн"
  },
  {
    "id": 342,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Безалкогольні напої"
  },
  {
    "id": 343,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Товари для тварин"
  },
  {
    "id": 344,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Побутова хімія"
  },
  {
    "id": 345,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Косметика"
  },
  {
    "id": 346,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Посуд"
  },
  {
    "id": 347,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Товари для дому"
  },
  {
    "id": 348,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Ванна кімната"
  },
  {
    "id": 349,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Ремонт"
  },
  {
    "id": 350,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Оствітлення"
  },
  {
    "id": 351,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Автотовари"
  },
  {
    "id": 352,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Рибалка та спорт"
  },
  {
    "id": 353,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Багаж"
  },
  {
    "id": 354,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Квіти"
  },
  {
    "id": 355,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Іграшки"
  },
  {
    "id": 356,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Канцелярські товари"
  },
  {
    "id": 357,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Книги"
  },
  {
    "id": 358,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Аудіо та відео техніка"
  },
  {
    "id": 359,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Дитячі товари"
  },
  {
    "id": 360,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Одяг"
  },
  {
    "id": 361,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Взуття"
  },
  {
    "id": 362,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Сезонні товари 1"
  },
  {
    "id": 363,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Сезонні товари 2"
  },
  {
    "id": 364,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Консерви, крупи"
  },
  {
    "id": 365,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Серверування столу"
  },
  {
    "id": 366,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Товари для саду"
  },
  {
    "id": 367,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Меблі"
  },
  {
    "id": 368,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Текстиль чоловічий"
  },
  {
    "id": 369,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Текстиль жіночий"
  },
  {
    "id": 370,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Сезонні товари 3"
  },
  {
    "id": 371,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Солодка бакалія"
  },
  {
    "id": 372,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Солона бакалія"
  },
  {
    "id": 373,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Безалкогольні нопої 2"
  },
  {
    "id": 374,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main - Ферма"
  },
  {
    "id": 375,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main - Біо товари дієтичне харчування"
  },
  {
    "id": 376,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Побутова техніка"
  },
  {
    "id": 377,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Соки"
  },
  {
    "id": 378,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Вхідні групи"
  },
  {
    "id": 379,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Парковка"
  },
  {
    "id": 380,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Торгівельна галерея"
  },
  {
    "id": 381,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Снеки"
  },
  {
    "id": 382,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Диабетичні товари, сніданки"
  },
  {
    "id": 383,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Масло, майонез"
  },
  {
    "id": 384,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Соління"
  },
  {
    "id": 387,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Солодка вода, сік"
  },
  {
    "id": 388,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Вино"
  },
  {
    "id": 389,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Все для свята"
  },
  {
    "id": 390,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Lviv-Ковбаса"
  },
  {
    "id": 391,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Lviv-Сир"
  },
  {
    "id": 392,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Сири вагові"
  },
  {
    "id": 393,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Ковбасні вироби"
  }
]


let hasCoordinates = function (obj) {
  let objHasCoordinates = true,
      coordinates = [
          obj.coordinates.x1,
          obj.coordinates.x2,
          obj.coordinates.y1,
          obj.coordinates.y2
      ];

  for (let item of coordinates) {
      if (item == null) objHasCoordinates = false;
  }

  return objHasCoordinates;
};


var app = new Vue({
  el: '#app',
  delimiters: ["<%","%>"],

  data: {
      zones: [],
      store: null,
      scheme: null,
      minSize: null,
      alertMessage: null,

      listWith: [],
      listWithOut:[],
      selectedZone: null,

      drawedZone: {
          x1: null,
          y1: null,
          x2: null,
          y2: null
      },

      canvasElement: null,
      imageElement: null,
      context: null,

      jsonData: undefined,
  },

  methods: {
      // EVENTS
      buttonMouseDown: function (event) {
          this.drawedZone.x1 = event.offsetX;
          this.drawedZone.y1 = event.offsetY;
      },
      buttonMouseUp: function (event) {
          let isSatisfiedSizeRectangle = function (zone) {
              let w = Math.abs(zone.x2 - zone.x1);
              let h = Math.abs(zone.y2 - zone.y1);
              if (w > app.minSize && h > app.minSize) {
                  return true;
              }
              return false;
          };

          this.drawedZone.x2 = event.offsetX;
          this.drawedZone.y2 = event.offsetY;

          if (isSatisfiedSizeRectangle(this.drawedZone)){
              this.openModalWindow();
          }
          else {
              alert(this.alertMessage + " " + this.minSize + " px.");
              this.clearDrawedZone();
              this.cleanCanvasAndDrawAllObjectsWithCoordinates();
          }
      },
      mouseMoveAndDraw: function (event) {
          if (this.drawedZone.x1 && this.drawedZone.y1) {
              this.cleanCanvasAndDrawAllObjectsWithCoordinates();

              const rect = new Facade.Rect({
                  x: this.drawedZone.x1,
                  y: this.drawedZone.y1,
                  width: event.offsetX - this.drawedZone.x1,
                  height: event.offsetY - this.drawedZone.y1,
                  lineWidth: 1,
                  strokeStyle: '#333E4B',
                  fillStyle: '#e0001a',
                  anchor: 'left',
                  opacity: 20,
              });

              this.canvasElement.addToStage(rect);
          }
      },

      // ADDITIONAL METHODS FOR EVENTS;
      openModalWindow: function () {
          //remove select2 select in modal windows;
          let select2Element = document.getElementsByClassName('select2-container');
          if (select2Element.length) select2Element[0].remove();

          //remove style for materialize select;
          let selectElement = document.getElementById('idSelectElement');
          selectElement.classList.remove('select2-hidden-accessible');

          this.modalElement.open();
      },
      removeZone: function (obj) {
          obj.coordinates.x1 = null;
          obj.coordinates.y1 = null;
          obj.coordinates.x2 = null;
          obj.coordinates.y2 = null;
          obj.is_updated = true;

          //UPDATE LIST OF ELEMENTS;
          this.updateLists();
      },
      addZone: function () {
          this.selectedZone.coordinates.x1 = this.drawedZone.x1;
          this.selectedZone.coordinates.y1 = this.drawedZone.y1;
          this.selectedZone.coordinates.x2 = this.drawedZone.x2;
          this.selectedZone.coordinates.y2 = this.drawedZone.y2;
          this.selectedZone.is_updated = true;

          //CLEAN DRAWED ZONE;
          this.clearDrawedZone();
          //UPDATE LIST OF ELEMENTS;
          this.updateLists();
      },

      // HELPFUL METHODS;
      updateLists: function () {
          this.listWith = this.zones.filter(zone => hasCoordinates(zone));
          this.listWithOut = this.zones.filter(zone => !hasCoordinates(zone));
      },
      clearDrawedZone: function () {
          this.drawedZone.x1 = null;
          this.drawedZone.y1 = null;
          this.drawedZone.x2 = null;
          this.drawedZone.y2 = null;
      },
      cleanCanvasAndDrawAllObjectsWithCoordinates: function () {
          // CLEAN CANVAS;
          this.context.drawImage(this.imageElement, 0, 0);
          // DRAW RECTANGLES;
          for (let item of this.listWith) {
              this.drawZone(item);
          }
      },
      drawZone: function (obj) {
          const rect = new Facade.Rect({
              x: obj.coordinates.x1,
              y: obj.coordinates.y1,
              width: obj.coordinates.x2 - obj.coordinates.x1,
              height: obj.coordinates.y2 - obj.coordinates.y1,
              lineWidth: 1,
              fillStyle: '#1C73A8',
              anchor: 'left',
              opacity: 20,
          });

          this.canvasElement.addToStage(rect);
      },
      onModalClose: function () {
          this.clearDrawedZone();
          this.cleanCanvasAndDrawAllObjectsWithCoordinates();
      },

      // UPDATED this.jsonData, WHICH WILL BE SENT TO BACKEND;
      getData: function () {
          return JSON.stringify({
              'store': this.store,
              'zones': this.zones.filter(zone => zone.is_updated)
          })
      },
  },

  computed: {
      modalElement: function () {
          let modal = document.getElementById('modal');
          return M.Modal.getInstance(modal);
      },
  },

  watch: {
      listWith: function () {
          this.cleanCanvasAndDrawAllObjectsWithCoordinates();
          this.jsonData = this.getData();
      }
  },

  created() {
      this.store = store;
      this.scheme = scheme;
      this.zones = data;
      this.minSize = min_size;
      this.alertMessage = alert_message;

      this.listWith = this.zones.filter(zone => hasCoordinates(zone));
      this.listWithOut = this.zones.filter(zone => !hasCoordinates(zone));
  },

  mounted() {
      // CANVAS INIT
      var img = new Image();
      img.onload = function () {
          var canvas = document.getElementById("mapAuchan");
          canvas.width = img.width;
          canvas.height = img.height;
          var context = canvas.getContext("2d");
          context.drawImage(img, 0, 0);

          app.cleanCanvasAndDrawAllObjectsWithCoordinates();
      };
      img.src = this.scheme;


      this.canvasElement = new Facade(document.querySelector('canvas'));
      this.imageElement = img;
      this.context = document.getElementById("mapAuchan").getContext('2d');


      // MODAL MATERIALIZE INIT
      var modalElements = document.querySelectorAll('.modal');
      M.Modal.init(modalElements, {
          onCloseStart: this.onModalClose
      });

      // SELECT MATERIALIZE INIT
      var selectElements = document.querySelectorAll('select');
      M.FormSelect.init(selectElements, {});
  }
});
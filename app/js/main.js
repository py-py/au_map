var data = [{
    "id": 327,
    "coordinates": {
      "id": 840,
      "x1": 10,
      "y1": 10,
      "x2": 100,
      "y2": 10
    },
    "has_coordinates": true,
    "is_updated": false,
    "name": "Main-М'ясо"
  },
  {
    "id": 328,
    "coordinates": {
      "id": 841,
      "x1": 20,
      "y1": 20,
      "x2": 120,
      "y2": 120
    },
    "has_coordinates": true,
    "is_updated": false,
    "name": "Main-Копченості"
  },
  {
    "id": 329,
    "coordinates": {
      "id": 842,
      "x1": 30,
      "y1": 40,
      "x2": 100,
      "y2": 100
    },
    "has_coordinates": true,
    "is_updated": false,
    "name": "Main-Хліб"
  },
  {
    "id": 330,
    "coordinates": {
      "id": 843,
      "x1": 40,
      "y1": 40,
      "x2": 100,
      "y2": 100
    },
    "has_coordinates": true,
    "is_updated": false,
    "name": "Main-Пекарня"
  },
  {
    "id": 331,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Ковбаса та сир"
  },
  {
    "id": 332,
    "coordinates": {
      "id": 845,
      "x1": 150,
      "y1": 250,
      "x2": 150,
      "y2": 250
    },
    "has_coordinates": true,
    "is_updated": false,
    "name": "Main-Молочні продукти, яйця"
  },
  {
    "id": 333,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Заморожені продукти"
  },
  {
    "id": 334,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Риба"
  },
  {
    "id": 335,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Овочі, фрукти"
  },
  {
    "id": 336,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Товари на вагу"
  },
  {
    "id": 337,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Кафе"
  },
  {
    "id": 338,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Кулінарія"
  },
  {
    "id": 339,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Бакалія"
  },
  {
    "id": 340,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Алкогольні напої"
  },
  {
    "id": 341,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Тютюн"
  },
  {
    "id": 342,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Безалкогольні напої"
  },
  {
    "id": 343,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Товари для тварин"
  },
  {
    "id": 344,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Побутова хімія"
  },
  {
    "id": 345,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Косметика"
  },
  {
    "id": 346,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Посуд"
  },
  {
    "id": 347,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Товари для дому"
  },
  {
    "id": 348,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Ванна кімната"
  },
  {
    "id": 349,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Ремонт"
  },
  {
    "id": 350,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Оствітлення"
  },
  {
    "id": 351,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Автотовари"
  },
  {
    "id": 352,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Рибалка та спорт"
  },
  {
    "id": 353,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Багаж"
  },
  {
    "id": 354,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Квіти"
  },
  {
    "id": 355,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Іграшки"
  },
  {
    "id": 356,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Канцелярські товари"
  },
  {
    "id": 357,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Книги"
  },
  {
    "id": 358,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Аудіо та відео техніка"
  },
  {
    "id": 359,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Дитячі товари"
  },
  {
    "id": 360,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Одяг"
  },
  {
    "id": 361,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Взуття"
  },
  {
    "id": 362,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Сезонні товари 1"
  },
  {
    "id": 363,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Сезонні товари 2"
  },
  {
    "id": 364,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Консерви, крупи"
  },
  {
    "id": 365,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Серверування столу"
  },
  {
    "id": 366,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Товари для саду"
  },
  {
    "id": 367,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Меблі"
  },
  {
    "id": 368,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Текстиль чоловічий"
  },
  {
    "id": 369,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Текстиль жіночий"
  },
  {
    "id": 370,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Сезонні товари 3"
  },
  {
    "id": 371,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Солодка бакалія"
  },
  {
    "id": 372,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Солона бакалія"
  },
  {
    "id": 373,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Безалкогольні нопої 2"
  },
  {
    "id": 374,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main - Ферма"
  },
  {
    "id": 375,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main - Біо товари дієтичне харчування"
  },
  {
    "id": 376,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Побутова техніка"
  },
  {
    "id": 377,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Соки"
  },
  {
    "id": 378,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Вхідні групи"
  },
  {
    "id": 379,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Парковка"
  },
  {
    "id": 380,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Main-Торгівельна галерея"
  },
  {
    "id": 381,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Снеки"
  },
  {
    "id": 382,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Диабетичні товари, сніданки"
  },
  {
    "id": 383,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Масло, майонез"
  },
  {
    "id": 384,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Соління"
  },
  {
    "id": 387,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Солодка вода, сік"
  },
  {
    "id": 388,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Вино"
  },
  {
    "id": 389,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Все для свята"
  },
  {
    "id": 390,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Lviv-Ковбаса"
  },
  {
    "id": 391,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Lviv-Сир"
  },
  {
    "id": 392,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Сири вагові"
  },
  {
    "id": 393,
    "coordinates": {
      "id": null,
      "x1": null,
      "y1": null,
      "x2": null,
      "y2": null
    },
    "has_coordinates": false,
    "is_updated": false,
    "name": "Zaporizhia-Ковбасні вироби"
  }
]


let hasCoordinates = function (obj) {
  let objHasCoordinates = true,
    coordinates = [
      obj.coordinates.x1,
      obj.coordinates.x2,
      obj.coordinates.y1,
      obj.coordinates.y2
    ];

  for (let item of coordinates) {
    if (item == null) objHasCoordinates = false;
  }

  return objHasCoordinates;
}

var app = new Vue({
  el: '#app',


  data: {
    // TODO: change;
    zones: data,
    store_id: 7,
    // TODO: change;
    map: 'http://localhost:3000/img/Bilychi_2018-fin.jpg',

    selectedWithCoordinates: null,
    selectedWithOutCoordinates: null,
    drawedZone: {
      x1: null,
      y1: null,
      x2: null,
      y2: null
    },

    canvasElement: null,
    imageElement: null,
    context: null,
  },


  methods: {
    // EVENTS
    buttonMouseDown: function (event) {
      this.drawedZone.x1 = event.offsetX;
      this.drawedZone.y1 = event.offsetY;
    },
    buttonMouseUp: function (event) {
      this.drawedZone.x2 = event.offsetX;
      this.drawedZone.y2 = event.offsetY;
      this.openModalWindow();
    },
    mouseMoveAndDraw: function (event) {
      if (this.drawedZone.x1 && this.drawedZone.y1) {

        // this.clearCanvas();
        this.drawAllObjectsWithCoordinates();

        const rect = new Facade.Rect({
          x: this.drawedZone.x1,
          y: this.drawedZone.y1,
          width: event.offsetX - this.drawedZone.x1,
          height: event.offsetY - this.drawedZone.y1,
          lineWidth: 1,
          strokeStyle: '#333E4B',
          fillStyle: '#e0001a',
          anchor: 'left',
          opacity: 20,
        });

        this.canvasElement.addToStage(rect);
      }
    },
    // ADDITIONAL METHODS FOR EVENTS;
    openModalWindow: function () {
      this.modalElement.open();
    },
    removeExistZone: function (obj) {
      obj.coordinates.x1 = null;
      obj.coordinates.y1 = null;
      obj.coordinates.x2 = null;
      obj.coordinates.y2 = null;
      // obj.has_coordinates = hasCoordinates(obj);
      obj.is_updated = true;
    },
    addZoneCoordinates: function () {
      this.selectedWithOutCoordinates.coordinates.x1 = this.drawedZone.x1;
      this.selectedWithOutCoordinates.coordinates.y1 = this.drawedZone.y1;
      this.selectedWithOutCoordinates.coordinates.x2 = this.drawedZone.x2;
      this.selectedWithOutCoordinates.coordinates.y2 = this.drawedZone.y2;
      // this.selectedWithOutCoordinates.has_coordinates = hasCoordinates(this.selectedWithOutCoordinates);
      this.selectedWithOutCoordinates.is_updated = true;

      this.clearDrawedZone();
    },
    // HELPFUL METHODS;
    clearDrawedZone: function () {
      this.drawedZone.x1 = null;
      this.drawedZone.y1 = null;
      this.drawedZone.x2 = null;
      this.drawedZone.y2 = null;
    },
    clearCanvas: function () {
      this.context.drawImage(this.imageElement, 0, 0);
    },
    drawAllObjectsWithCoordinates: function () {
      this.clearCanvas();
      for (let item of this.listWithCoordinates) {
        this.drawMe(item);
      }
    },
    drawMe: function (obj) {
      const rect = new Facade.Rect({
        x: obj.coordinates.x1,
        y: obj.coordinates.y1,
        width: obj.coordinates.x2 - obj.coordinates.x1,
        height: obj.coordinates.y2 - obj.coordinates.y1,
        lineWidth: 1,
        fillStyle: '#1C73A8',
        anchor: 'left',
        opacity: 20,
      });

      this.canvasElement.addToStage(rect);
    },
    onModalClose: function () {
      this.clearDrawedZone();
      // this.clearCanvas();
    },
  },


  computed: {
    listWithCoordinates: function () {
      return this.zones.filter(zone => hasCoordinates(zone));
    },
    listWithOutCoordinates: function () {
      return this.zones.filter(zone => !hasCoordinates(zone));
    },
    modalElement: function () {
      let modal = document.getElementById('modal');
      return M.Modal.getInstance(modal);
    },
    //FORM DATA;
    jsonData: function () {
      return JSON.stringify({
        'store_id': this.store_id,
        'zones': this.zones
      })
    }
  },

  watch: {
    listWithCoordinates: function () {
      this.drawAllObjectsWithCoordinates();
    }
  },

  mounted() {
    // CANVAS INIT
    var img = new Image();
    img.onload = function () {
      var canvas = document.getElementById("mapAuchan");
      canvas.width = img.width;
      canvas.height = img.height;
      var context = canvas.getContext("2d");
      context.drawImage(img, 0, 0);

      app.drawAllObjectsWithCoordinates();
    }
    img.src = this.map; 
    

    this.canvasElement = new Facade(document.querySelector('canvas'));
    this.imageElement = img;
    this.context = document.getElementById("mapAuchan").getContext('2d');
       

    // MODAL MATERIALIZE INIT
    var modalElements = document.querySelectorAll('.modal');
    M.Modal.init(modalElements, {
      onCloseStart: this.onModalClose
    });

    // SELECT MATERIALIZE INIT
    var selectElements = document.querySelectorAll('select');
    M.FormSelect.init(selectElements, {});
  }
})